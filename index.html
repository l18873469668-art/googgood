<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”æ³•åœ£è¯æ ‘ (V3æé€Ÿç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #333;
            border-top-color: #d4af37; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loader-text { color: #d4af37; font-size: 16px; margin-bottom: 10px;}
        #error-log { color: #ff4444; font-size: 12px; max-width: 80%; text-align: center; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; padding: 20px; }
        .hud { pointer-events: auto; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; border: 1px solid #444; max-width: 300px;}
        .status { color: #fff; margin: 5px 0; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .status.active { color: #d4af37; font-weight: bold; }
        .btn { background: #d4af37; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; }
        
        #video-preview { position: absolute; top: 10px; right: 10px; width: 80px; height: 60px; opacity: 0.5; transform: scaleX(-1); border: 1px solid #d4af37; z-index: 20; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">æ­£åœ¨ä»é¥¿äº†ä¹ˆCDNåŠ è½½...</div>
        <div id="error-log"></div>
    </div>

    <video id="video-preview" playsinline muted></video>

    <div id="ui-layer">
        <div class="hud">
            <h3 style="margin:0 0 10px 0; color:#d4af37;">ğŸ„ é­”æ³•æ§åˆ¶å°</h3>
            <div id="s-fist" class="status">âœŠ æ¡æ‹³ï¼šå˜åœ£è¯æ ‘</div>
            <div id="s-open" class="status">ğŸ– å¼ å¼€ï¼šç‚¸å¼€æ•£è½</div>
            <div id="s-pinch" class="status">ğŸ¤ æåˆï¼šçœ‹ç…§ç‰‡</div>
            <button class="btn" onclick="document.getElementById('file').click()">ğŸ“· ä¸Šä¼ ç…§ç‰‡</button>
            <input type="file" id="file" multiple accept="image/*" style="display:none">
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://npm.elemecdn.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://npm.elemecdn.com/three@0.160.0/examples/jsm/",
                "@mediapipe/hands": "https://npm.elemecdn.com/@mediapipe/hands@0.4.1675469240/hands.js",
                "@mediapipe/camera_utils": "https://npm.elemecdn.com/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js",
                "tween": "https://npm.elemecdn.com/@tweenjs/tween.js@18.6.4/dist/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        // é”™è¯¯æ•è·
        window.onerror = function(msg, url, line) {
            document.getElementById('error-log').innerText = "åŠ è½½å‡ºé”™: " + msg;
        };

        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { Hands } from '@mediapipe/hands';
        import { Camera } from '@mediapipe/camera_utils';
        import TWEEN from 'tween';

        // é…ç½®ï¼šMediaPipe èµ„æºä¹Ÿèµ°é¥¿äº†ä¹ˆæº
        const MP_BASE = "https://npm.elemecdn.com/@mediapipe/hands@0.4.1675469240/";
        
        let scene, camera, renderer, composer, controls;
        let particles = [], photos = [];
        let currentState = 'tree';

        // 1. åˆå§‹åŒ– 3D
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 40);
            
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // ç®€å•ç¯å…‰
            scene.add(new THREE.AmbientLight(0xffffff, 2));
            const light = new THREE.PointLight(0d4af37, 2, 100);
            light.position.set(0,20,10);
            scene.add(light);

            // è¾‰å…‰
            const renderScene = new RenderPass(scene, camera);
            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloom.strength = 1.2;
            bloom.radius = 0.5;
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloom);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.autoRotate = true;

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            createParticles();
            document.getElementById('loader-text').innerText = "3DåŠ è½½å®Œæˆï¼Œæ­£åœ¨è¿æ¥AI...";
        }

        function createParticles() {
            particles.forEach(p => scene.remove(p.mesh));
            particles = [];
            
            const geo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            const mat = new THREE.MeshStandardMaterial({color: 0xd4af37, metalness: 0.8, roughness: 0.1});

            for(let i=0; i<400; i++) {
                let mesh;
                if(photos.length > 0 && i%15===0) {
                    const tex = photos[Math.floor(Math.random()*photos.length)];
                    mesh = new THREE.Mesh(new THREE.PlaneGeometry(3,3), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
                } else {
                    mesh = new THREE.Mesh(geo, mat);
                }
                
                // æ ‘åæ ‡
                const y = (Math.random()*30)-15;
                const r = (1-(y+15)/30)*12;
                const theta = Math.random()*Math.PI*2;
                const treePos = {x: r*Math.cos(theta), y:y, z:r*Math.sin(theta)};
                
                // æ•£è½åæ ‡
                const sR = 20 + Math.random()*30;
                const sPhi = Math.random()*Math.PI*2;
                const sTheta = Math.random()*Math.PI*2;
                const scatterPos = {x: sR*Math.sin(sPhi)*Math.cos(sTheta), y: sR*Math.sin(sPhi)*Math.sin(sTheta), z: sR*Math.cos(sPhi)};

                mesh.position.set(treePos.x, treePos.y, treePos.z);
                mesh.lookAt(0,0,0);
                scene.add(mesh);
                particles.push({mesh, treePos, scatterPos, curr: 'tree'});
            }
        }

        // 2. åˆå§‹åŒ– AI
        async function initAI() {
            try {
                const video = document.getElementById('video-preview');
                const hands = new Hands({
                    locateFile: (file) => {
                        return `${MP_BASE}${file}`;
                    }
                });
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                hands.onResults(onResults);

                const cam = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 640, height: 480
                });
                await cam.start();
                
                document.getElementById('loader').style.display = 'none'; // æˆåŠŸï¼
            } catch(e) {
                document.getElementById('loader-text').innerText = "åŠ è½½å¤±è´¥";
                document.getElementById('error-log').innerText = "è¯·æ£€æŸ¥ç½‘ç»œæˆ–å…è®¸æ‘„åƒå¤´æƒé™ã€‚\n" + e.message;
            }
        }

        function onResults(results) {
            if(!results.multiHandLandmarks || !results.multiHandLandmarks.length) return;
            const lm = results.multiHandLandmarks[0];
            
            // ç®€å•æ‰‹åŠ¿
            const wrist = lm[0];
            const tips = [8,12,16,20];
            let open = 0;
            tips.forEach(t => {
                if(Math.sqrt((lm[t].x-wrist.x)**2 + (lm[t].y-wrist.y)**2) > 0.2) open++;
            });
            
            const pinch = Math.sqrt((lm[4].x-lm[8].x)**2 + (lm[4].y-lm[8].y)**2) < 0.05;

            // çŠ¶æ€åˆ¤æ–­
            if(pinch) updateState('pinch');
            else if(open > 3) updateState('open');
            else if(open < 2) updateState('fist');
        }

        function updateState(state) {
            document.querySelectorAll('.status').forEach(el => el.classList.remove('active'));
            if(state === 'fist') {
                document.getElementById('s-fist').classList.add('active');
                if(currentState !== 'tree') transform('tree');
            } else if(state === 'open') {
                document.getElementById('s-open').classList.add('active');
                if(currentState !== 'scatter') transform('scatter');
            } else if(state === 'pinch') {
                document.getElementById('s-pinch').classList.add('active');
            }
        }

        function transform(target) {
            currentState = target;
            controls.autoRotate = (target === 'tree');
            particles.forEach(p => {
                const pos = target === 'tree' ? p.treePos : p.scatterPos;
                new TWEEN.Tween(p.mesh.position).to(pos, 1000).easing(TWEEN.Easing.Cubic.Out).start();
                new TWEEN.Tween(p.mesh.rotation).to({x:Math.random()*3, y:Math.random()*3}, 1000).start();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            composer.render();
        }

        // ä¸Šä¼ 
        document.getElementById('file').onchange = function(e) {
            photos = [];
            Array.from(e.target.files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    new THREE.TextureLoader().load(ev.target.result, (tex) => {
                        photos.push(tex);
                        if(photos.length === e.target.files.length) createParticles();
                    });
                };
                reader.readAsDataURL(f);
            });
        };

        initThree();
        initAI();
        animate();
    </script>
</body>
</html>
