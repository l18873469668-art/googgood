<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ„ åœ£è¯æ ‘ (V4 å…œåº•ç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* é”™è¯¯æç¤ºæ¡ */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(200, 0, 0, 0.8); color: white;
            font-size: 12px; padding: 5px; text-align: center;
            z-index: 1000; display: none;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; padding: 20px; box-sizing: border-box;}
        .hud { pointer-events: auto; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); max-width: 320px; backdrop-filter: blur(5px);}
        .hud h3 { margin: 0 0 10px 0; color: #d4af37; text-align: center; }
        .status { color: #ccc; margin: 6px 0; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .status span { display: inline-block; width: 20px; }
        .status.active { color: #fff; text-shadow: 0 0 5px #d4af37; font-weight: bold; }
        
        .btn { 
            background: linear-gradient(45deg, #d4af37, #b8860b); 
            border: none; padding: 12px; border-radius: 25px; 
            color: #fff; font-weight: bold; cursor: pointer; 
            margin-top: 15px; width: 100%; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #video-preview { 
            position: absolute; top: 10px; right: 10px; width: 80px; height: 60px; 
            border: 2px solid #333; border-radius: 5px; opacity: 0.5; 
            transform: scaleX(-1); z-index: 20; background: #000;
        }
    </style>
</head>
<body>

    <div id="status-bar"></div>

    <video id="video-preview" playsinline muted></video>

    <div id="ui-layer">
        <div class="hud">
            <h3>âœ¨ é­”æ³•åœ£è¯æ ‘</h3>
            <div id="s-fist" class="status"><span>âœŠ</span> æ¡æ‹³ï¼šèšåˆ</div>
            <div id="s-open" class="status"><span>ğŸ–</span> å¼ å¼€ï¼šç‚¸å¼€</div>
            <div id="s-pinch" class="status"><span>ğŸ¤</span> æåˆï¼šçœ‹ç…§ç‰‡</div>
            
            <button class="btn" onclick="document.getElementById('file').click()">ğŸ“· ä¸Šä¼ ç…§ç‰‡ (å¿…é€‰)</button>
            <input type="file" id="file" multiple accept="image/*" style="display:none">
            
            <p style="color:#666; font-size:10px; text-align:center; margin-top:10px;">
                å¦‚æœæ‰‹åŠ¿æ²¡ååº”ï¼Œè¯·ç›´æ¥ç”¨æ‰‹æŒ‡/é¼ æ ‡æ‹–åŠ¨å±å¹•
            </p>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.bootcdn.net/ajax/libs/three.js/0.160.0/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@mediapipe/hands": "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js",
                "@mediapipe/camera_utils": "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js",
                "tween": "https://cdn.bootcdn.net/ajax/libs/tween.js/18.6.4/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { Hands } from '@mediapipe/hands';
        import { Camera } from '@mediapipe/camera_utils';
        import TWEEN from 'tween';

        // å°è¯•å¤šä¸ªæºï¼Œé˜²æ­¢æ­»é”
        const MP_URL = "https://cdn.jsdelivr.net/npm/@mediapipe/hands/";

        let scene, camera, renderer, composer, controls;
        let particles = [], photos = [];
        let currentState = 'tree';

        // --- ç«‹å³å¯åŠ¨ 3D åœºæ™¯ï¼Œä¸ç­‰å¾… AI ---
        initThree();
        // --- å¼‚æ­¥æ‚„æ‚„åŠ è½½ AI ---
        initAI();

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 40);
            
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // ç¯å…‰
            scene.add(new THREE.AmbientLight(0xffffff, 1.5));
            const light = new THREE.PointLight(0xd4af37, 2, 100);
            light.position.set(0,20,10);
            scene.add(light);

            // è¾‰å…‰
            const renderScene = new RenderPass(scene, camera);
            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloom.strength = 1.0; 
            bloom.radius = 0.5;
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloom);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.autoRotate = true;
            controls.enableDamping = true;

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            createParticles();
            animate();
        }

        function createParticles() {
            particles.forEach(p => scene.remove(p.mesh));
            particles = [];
            
            const geo = new THREE.BoxGeometry(0.6, 0.6, 0.6);
            const mat = new THREE.MeshStandardMaterial({color: 0xd4af37, metalness: 0.9, roughness: 0.1});

            // é»˜è®¤ç»™ç‚¹é¢œè‰²
            for(let i=0; i<400; i++) {
                let mesh;
                if(photos.length > 0 && i%10===0) {
                    const tex = photos[Math.floor(Math.random()*photos.length)];
                    mesh = new THREE.Mesh(new THREE.PlaneGeometry(3,3), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
                } else {
                    mesh = new THREE.Mesh(geo, mat);
                }
                
                const y = (Math.random()*30)-15;
                const r = (1-(y+15)/30)*12;
                const theta = Math.random()*Math.PI*2;
                const treePos = {x: r*Math.cos(theta), y:y, z:r*Math.sin(theta)};
                
                const sR = 20 + Math.random()*30;
                const sPos = {
                    x: sR * (Math.random()-0.5)*2,
                    y: sR * (Math.random()-0.5)*2,
                    z: sR * (Math.random()-0.5)*2
                };

                mesh.position.set(treePos.x, treePos.y, treePos.z);
                mesh.lookAt(0,0,0);
                scene.add(mesh);
                particles.push({mesh, treePos, scatterPos: sPos});
            }
        }

        async function initAI() {
            try {
                const video = document.getElementById('video-preview');
                const hands = new Hands({
                    locateFile: (file) => {
                        return `${MP_URL}${file}`;
                    }
                });
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                hands.onResults(onResults);

                const cam = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 640, height: 480
                });
                await cam.start();
                
            } catch(e) {
                console.log(e);
                const bar = document.getElementById('status-bar');
                bar.style.display = 'block';
                bar.innerText = "âš ï¸ AI æ¨¡å‹åŠ è½½å¤±è´¥ (ç½‘ç»œé—®é¢˜)ï¼Œå·²åˆ‡æ¢ä¸ºä»…è§¦æ‘¸æ¨¡å¼ã€‚è¯·å°è¯•åˆ‡æ¢ WiFi/æµé‡ åˆ·æ–°ã€‚";
            }
        }

        function onResults(results) {
            if(!results.multiHandLandmarks || !results.multiHandLandmarks.length) return;
            const lm = results.multiHandLandmarks[0];
            
            const wrist = lm[0];
            const tips = [8,12,16,20];
            let open = 0;
            tips.forEach(t => {
                if(Math.sqrt((lm[t].x-wrist.x)**2 + (lm[t].y-wrist.y)**2) > 0.2) open++;
            });
            
            const pinch = Math.sqrt((lm[4].x-lm[8].x)**2 + (lm[4].y-lm[8].y)**2) < 0.05;

            // UI æ›´æ–°
            document.querySelectorAll('.status').forEach(el => el.classList.remove('active'));

            if(pinch) {
                document.getElementById('s-pinch').classList.add('active');
            } else if(open > 3) {
                document.getElementById('s-open').classList.add('active');
                if(currentState !== 'scatter') transform('scatter');
            } else if(open < 2) {
                document.getElementById('s-fist').classList.add('active');
                if(currentState !== 'tree') transform('tree');
            }
        }

        function transform(target) {
            currentState = target;
            controls.autoRotate = (target === 'tree');
            particles.forEach(p => {
                const pos = target === 'tree' ? p.treePos : p.scatterPos;
                new TWEEN.Tween(p.mesh.position).to(pos, 1000).easing(TWEEN.Easing.Cubic.Out).start();
                new TWEEN.Tween(p.mesh.rotation).to({x:Math.random()*3, y:Math.random()*3}, 1000).start();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            composer.render();
        }

        document.getElementById('file').onchange = function(e) {
            photos = [];
            Array.from(e.target.files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    new THREE.TextureLoader().load(ev.target.result, (tex) => {
                        tex.colorSpace = THREE.SRGBColorSpace;
                        photos.push(tex);
                        if(photos.length === e.target.files.length) createParticles();
                    });
                };
                reader.readAsDataURL(f);
            });
        };
    </script>
</body>
</html>
